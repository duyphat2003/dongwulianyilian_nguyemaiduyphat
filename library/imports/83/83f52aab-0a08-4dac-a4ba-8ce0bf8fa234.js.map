{"version":3,"sources":["assets\\framework\\plugin_boosts\\gamesys\\FSM.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\nconst {ccclass, property} = cc._decorator;\r\n\r\nexport class State \r\n{\r\n    name:string;\r\n    id: number;\r\n\r\n    constructor(id?,name?)\r\n    {\r\n        this.id = id;\r\n        this.name = name;\r\n    }\r\n    onEnter(params?){}\r\n    onExit(){}\r\n    onUpdate(dt){}\r\n    //messages \r\n    on(){}\r\n    off(){}\r\n\r\n    __interval_callbacks = []\r\n\r\n    clearIntervals()\r\n    {\r\n        this.__interval_callbacks.splice(0 ,this.__interval_callbacks.length)\r\n    }\r\n\r\n    interval_id:number = 0;\r\n\r\n    setInterval(interval,callback,target?)\r\n    {\r\n        let id = ++ this.interval_id;\r\n        let timer = 0;\r\n        this.__interval_callbacks.push({id,callback,target,interval,timer});\r\n        return id;\r\n    }\r\n\r\n    clearInterval(id)\r\n    {\r\n        this.__interval_callbacks.splice(this.__interval_callbacks.indexOf(id))\r\n    }\r\n\r\n\r\n    setTimeout(delay,callback,target?)\r\n    {\r\n        let id = ++ this.interval_id;\r\n        let timer = 0;\r\n        this.__interval_callbacks.push({id,callback,target,delay,timer});\r\n        return id;\r\n    }\r\n\r\n    clearTimeout(id)\r\n    {\r\n        this.clearInterval(id)\r\n    }\r\n\r\n    invokeIntervals(dt)\r\n    {\r\n        for (let i = 0; i < this.__interval_callbacks.length; i++) {\r\n            const element = this.__interval_callbacks[i];\r\n            element.timer = element.timer + dt;\r\n            if(element.interval)\r\n            {\r\n                if(element.timer >= element.interval)\r\n                {\r\n                    element.timer = 0;\r\n                    // call\r\n                    element.callback.call(element.target)\r\n                }\r\n            }else if(element.delay)\r\n            {\r\n                if(element.timer >= element.delay)\r\n                {\r\n                    // call\r\n                    element.callback.call(element.target)\r\n                    this.__interval_callbacks.splice(i);\r\n                    i --;\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nclass CustomState extends State\r\n{\r\n    __enterFunc:Function;\r\n    __exitFunc:Function;\r\n    __updateFunc:Function;\r\n    __target:any;\r\n    constructor(target,id,name,pattern)\r\n    {\r\n        super(id,name);\r\n        let enterName = cc.js.formatStr(pattern,\"onEnter\",this.name)\r\n        let updateName = cc.js.formatStr(pattern,\"onUpdate\",this.name)\r\n        let exitName = cc.js.formatStr(pattern,\"onExit\",this.name)\r\n        this.__target = target;\r\n        this.__enterFunc = this.__target[enterName];\r\n        this.__updateFunc = this.__target[updateName];\r\n        this.__exitFunc = this.__target[exitName];\r\n        \r\n    }\r\n    onEnter(params){\r\n        this.clearIntervals();\r\n        if (this.__enterFunc)\r\n        {\r\n            this.__enterFunc.call(this.__target,this,params);\r\n        }\r\n    }\r\n    onExit(){\r\n        if (this.__exitFunc)\r\n        {\r\n            this.__exitFunc.call(this.__target,this);\r\n        }\r\n    }\r\n    onUpdate(dt){\r\n        this.invokeIntervals(dt);\r\n        if (this.__updateFunc)\r\n        {\r\n            this.__updateFunc.call(this.__target,this,dt);\r\n        }\r\n    }\r\n\r\n}\r\n\r\nexport default class FSM extends cc.Component\r\n{\r\n    c:State;\r\n    p:State;\r\n    _target:any;\r\n\r\n    timeElapsed:number = 0;\r\n\r\n    _states:{[index:number]:State } = {}\r\n\r\n    _isPaused = false;\r\n\r\n    namePattern:string;\r\n\r\n    log:boolean = false;\r\n\r\n    get target():any\r\n    {\r\n        return this._target;\r\n    }\r\n\r\n    init(target:any)\r\n    {\r\n        this._target = target;\r\n        this.timeElapsed = 0;\r\n    }\r\n\r\n    getState(stateId)\r\n    {\r\n        return this._states[stateId];\r\n    }\r\n\r\n    getCurrentState()\r\n    {\r\n        return this.c\r\n    }\r\n\r\n    getPreviousState()\r\n    {\r\n        return this.p;\r\n    }\r\n\r\n\r\n\r\n    addStates(states:any,callbackNamePattern = \"%s_%sState\")\r\n    {\r\n        let keys = Object.keys(states);\r\n        let enumLen = (keys.length/2);\r\n        this.namePattern = callbackNamePattern;\r\n        for(var i = 0;i < enumLen;i++)\r\n        {\r\n            let key = keys[i]\r\n            let value = states[key];\r\n            \r\n            this.addState(key,value)\r\n        }\r\n    }\r\n\r\n    addState(id,name,enterCallback?,exitCallback?,updateCallback?,target?)\r\n    {\r\n        if(this.log)\r\n            console.log(\"[FSM]\"+this.target.__classname__ + \"(\"+ this.target.name+\")\"+\" Add State :\" ,id, name)\r\n        let state = new CustomState(this.target,id,name,this.namePattern);\r\n        this._states[id] = state;\r\n        if(enterCallback)\r\n            state.__enterFunc = enterCallback;\r\n        if(exitCallback)\r\n            state.__exitFunc = exitCallback;\r\n        if(updateCallback)\r\n            state.__updateFunc = updateCallback;\r\n        if(target)\r\n            state.__target = target;\r\n    }\r\n\r\n    /**\r\n     * first state \r\n     * @param: state index or State\r\n     */\r\n    enterState(stateId:number,params?)\r\n    {\r\n        this.timeElapsed = 0\r\n        let state = this._states[stateId]\r\n        this.c = state;\r\n        state.onEnter(params);\r\n        if(this.log)\r\n            console.log(\"[FSM]\"+this.target.__classname__ +\" First State:\" ,state.name)\r\n    }\r\n\r\n    revertState()\r\n    {\r\n    \tthis.changeState(this.p.id);\r\n    }\r\n\r\n\r\n    pause()\r\n    {\r\n        this._isPaused = true;\r\n    }\r\n\r\n    resume()\r\n    {\r\n        this._isPaused = false;\r\n    }\r\n\r\n    resetCurrentState()\r\n    {\r\n        this.timeElapsed = 0\r\n        console.log(cc.js.formatStr(\"[FSM] %s reset currentState\",this.target.__classname__))\r\n        this.c.onExit();\r\n        this.c.onEnter();\r\n    }\r\n\r\n    changeState(stateId:number,params?)\r\n    {\r\n        let state = this._states[stateId]\r\n        if(state == null)\r\n        {\r\n            console.warn(\"[FSM] invalid state for stateId \" + stateId +\" of : \" +  this.target.__classname__)\r\n            return;\r\n        }\r\n        if(this._isPaused) \r\n        {\r\n            console.warn(\"[FSM] fsm is paused ! \"+this.target.__classname__+\" changeState to <\"+ state.name + \"> failed!\")\r\n            return \r\n        }\r\n        if(stateId == this.c.id) return;\r\n        this.timeElapsed = 0\r\n        this.c.onExit();\r\n        this.p = this.c;\r\n        this.c = state;\r\n        if(this.log)\r\n            console.log(cc.js.formatStr(\"[FSM] %s (%s): %s -> %s\",this.target.__classname__,this.name,this.p.name , state.name))\r\n        this.c.onEnter(params);\r\n        \r\n    }\r\n\r\n    isInState(stateId)\r\n    {\r\n        return this.c == this._states[stateId]\r\n    }\r\n    static debug = false;\r\n    update(dt)\r\n    {\r\n        if(this._isPaused) return;\r\n        if(FSM.debug)\r\n            dt = 0.016 ; // use real deta\r\n        this.timeElapsed += dt;\r\n        if(this.c)\r\n            this.c.onUpdate(dt);\r\n    }\r\n\r\n    \r\n}"]}