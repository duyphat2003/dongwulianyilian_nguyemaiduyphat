{"version":3,"sources":["assets\\framework\\wxsdk\\MoreGameManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import MoreGameComponent from \"./MoreGameComponent\";\nimport { GameConfig } from \"./GameConfigs\";\n\nconst {ccclass, property} = cc._decorator;\n\nexport class Task\n{\n    id:number;\n    gameConfig: any;\n    isRunning: boolean = false;\n    cd : number = 0;\n    max_cd :number = 0;\n    constructor(id)\n    {\n        this.id = id;\n    }\n\n    start()\n    {\n        this.isRunning = true;\n    }\n\n    finish()\n    {\n        this.isRunning = false;\n        this.cd = this.max_cd;\n    }\n}\n\n@ccclass\nexport default class MoreGameManager extends cc.Component {\n\n    @property([MoreGameComponent])\n    recommendComps :MoreGameComponent[] = [];\n\n    private static _instance:MoreGameManager\n    static get instance():MoreGameManager \n    {\n        if (this._instance == null)\n        {\n            this._instance = cc.find(\"Canvas\").addComponent(MoreGameManager);\n        }\n        return this._instance;\n    }\n\n    static set instance(k)\n    {\n        this._instance = k;\n    }\n\n    gameList:any[] = []\n\n    tasks:Task[] = []\n\n    frames:{[index:string]:cc.SpriteFrame} = {};\n\n    /**\n        content:\"射了个球\"\n        extra:\"\"\n        icon:\"https://111.231.94.213/game/gameres/recommend/game_01/icon.jpg\"\n        id:1\n        image:\"https://111.231.94.213/game/gameres/recommend/game_01/qr.png\"\n        title:\"射了个球\"\n        wx_appid:\"wxcd56cd0a66199638\"\n        launch:\"\"\n    */\n    async getSpriteFrame(url:string):Promise<cc.SpriteFrame>\n    {\n        let frame = this.frames[url]\n        if(frame == null)\n        {\n            return new Promise<cc.SpriteFrame>((resolve,reject)=>{\n                // url = \"https://cs-op.douyucdn.cn/douyu/2018/02/09/8a0dd8f98a3fa07c9543800173408477.png\"\n                console.log(\"[MoreGameManager] request image:\" + url)\n                cc.loader.load({url: url, type: 'png'}, (err, texture) =>{\n                    \n                    if(texture)\n                    {\n                        frame = new cc.SpriteFrame(texture);\n                        this.addSpriteFrame(url ,frame)\n                        // this.node.getComponent(cc.Sprite).spriteFrame=frame;\n                        resolve(frame)\n                    }else{\n                        reject()\n                    }\n                    \n                });\n            })\n        }\n        return new Promise<cc.SpriteFrame>((resolve,reject)=>resolve(frame));\n        \n    }\n\n    addSpriteFrame(url: string, frame: any): any {\n        this.frames[url] = frame;\n        return frame;\n    }\n\n    onLoad()\n    {\n        MoreGameManager.instance = this;\n    }\n\n    //tasks\n    getTasks(priority_min: number,count:number): any {\n        let todo = []\n        for (var i = 0; i <this.tasks.length; i ++)\n        {\n            let task = this.tasks[i]\n            if(task.gameConfig.priority && task.gameConfig.priority > priority_min)\n            {\n                if(task.cd == 0)\n                {\n                    todo.push(task)\n                    this.tasks.splice(i,1)\n                    i--;\n                }\n            }\n            if (todo.length >= count) break;\n        }\n        if(todo.length < count)\n        {\n            // 任务不足，直接用cd中的任务补充\n            //request from cd tasks \n            for (var i = 0; i <this.tasks.length; i ++)\n            {\n                let task = this.tasks[i]\n                if(todo.indexOf(task) == -1)\n                {\n                    todo.push(task);\n                    this.tasks.splice(i,1)\n                    i -- ;\n                }\n            }\n        }\n        g.extendArray(this.tasks,todo);\n        return todo;\n    }\n\n    finishTasks(list: Task[]): any {\n        for(var i = 0 ;i < list.length; i ++ )\n        {\n            let task = list[i];\n            if (task)\n            {\n                task.finish();\n            }\n        }\n    }\n\n    startTasks(list:Task[]):any{\n\n        for(var i = 0 ;i < list.length; i ++ )\n        {\n            let task = list[i]; \n            if (task)\n            {\n                task.start();\n            }\n        }\n    }\n    \n    createTasks()\n    {\n        for (var i = 0 ;  i < this.gameList.length;i++)\n        {\n            let task = new Task(i)\n            task.gameConfig = this.gameList[i]\n            task.gameConfig.priority = task.gameConfig.priority ||100;\n            // 10 最小cd 时长 \n            task.max_cd =  100 /task.gameConfig.priority * 10;\n            this.tasks.push(task)\n        }\n    }\n\n    addList(list:any)\n    {\n        if(list == null)\n            return;\n        if (Array.isArray(list) )\n        {\n            this.gameList.splice(0,this.gameList.length);\n            g.extendArray(this.gameList,list);\n        }else{\n            this.gameList.push(list);\n        }\n        //sort by priority \n        this.gameList.sort((a,b)=>{\n            if(!a.priority ) return 1;\n            if(!b.priority) return 0;\n            return b.priority - a.priority;\n        })\n        //create tasks\n        this.createTasks();\n\n        for (let i = 0; i < this.recommendComps.length; i++) {\n            const element = this.recommendComps[i];\n            element.requestTask()\n        }\n\n    }\n\n    updateFinishedTask()\n    {\n        for (var i = 0; i < this.tasks.length; i++)\n        {\n            let task = this.tasks[i]\n            //cd 中的任务\n            if(task.cd > 0)\n            {\n                task.cd = Math.max(0,task.cd - 1);\n            }\n        }\n    }\n    /**\n     * appId\tstring\t\t是\t要打开的小程序 appId\t\n        path\tstring\t\t否\t打开的页面路径，如果为空则打开首页\t\n        extraData\tobject\t\t否\t需要传递给目标小程序的数据，目标小程序可在 App.onLaunch，App.onShow 中获取到这份数据。\t\n        envVersion\tstring\trelease\t否\t要打开的小程序版本。仅在当前小程序为开发版或体验版时此参数有效。如果当前小程序是正式版，则打开的小程序必定是正式版。\t\n        success\tfunction\t\t否\t接口调用成功的回调函数\t\n        fail\tfunction\t\t否\t接口调用失败的回调函数\t\n        complete\tfunction\t\t否\t接口调用结束的回调函数（调用成功、失败都会执行）\n        object.envVersion 的合法值\n\n        envVersion >>--------------------\n        develop\t开发版\n        trial\t体验版\n        release\t正式版\n     */\n    clickGame(gamecfg)\n    {\n        console.log(\"打开小程序...\")\n        wx.navigateToMiniProgram({\n            appId:gamecfg.wx_appid,\n            extraData:{\n                wx_appid:GameConfig.wx_appid,\n            },\n            envVersion:\"release\",\n            success:(res)=>{\n                console.log(\"打开小程序成功 :\" + gamecfg.wx_appid)\n                // 跳转通知服务器\n\n            },\n            fail:(res)=>{\n                //打开失败\n                console.log(\"打开小程序失败 :\" +gamecfg.wx_appid)\n            }\n        })\n        \n        // 打开详情 或者直接打开\n        //cfg.image  \n    }\n\n    onEnable()\n    {\n        this.schedule(this.updateFinishedTask,1,cc.macro.REPEAT_FOREVER);\n    }\n\n    onDisable()\n    {\n        this.unschedule(this.updateFinishedTask);\n    }\n\n    start()\n    {\n        // let gameList  = [\n        //     {\n        //         content:\"射了个球\",\n        //         extra:\"\",\n        //         icon:\"https://111.231.94.213/game/gameres/recommend/game_01/icon.jpg\",\n        //         id:1,\n        //         image:\"https://111.231.94.213/game/gameres/recommend/game_01/qr.png\",\n        //         title:\"射了个球\",\n        //         wx_appid:\"wxcd56cd0a66199638\",\n        //         priority: 99,\n        //     }\n        // ]\n        // let test = JSON.parse('{\"priority\":100,\"title\":\"水果泡泡龙\",\"extra\":\"empty\",\"icon\":\"https://7265-release-2c87c4-1258399463.tcb.qcloud.la/pplicon.png?sign=43116a5ecfead6e614c52b9818cb15ec\\u0026t=1547972497\",\"image\":\"https://7265-release-2c87c4-1258399463.tcb.qcloud.la/qrcode (2).jpg?sign=43edc51f924e8a4e969e71c5e0753adf\\u0026t=1547972423\",\"wx_appid\":\"wxdbacbba2d0277152\"}')\n        // gameList.push(test);\n        // this.addList(gameList)\n    }\n}"]}