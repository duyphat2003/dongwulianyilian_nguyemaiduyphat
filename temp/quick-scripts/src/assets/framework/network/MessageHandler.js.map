{"version":3,"sources":["assets\\framework\\network\\MessageHandler.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { Message } from \"./Message\";\r\nimport {SocketTag} from \"./MessageType\"\r\nimport {MessageDispatch} from \"./MessageDispatch\"\r\nexport class MessageHandler {\r\n\tprivate _webSocket: WebSocket;\r\n\tprivate _writeMessage: Message[] = null;\r\n\tprivate _messages: any[] = null;\r\n\tprivate _heartbeatInterval: number;\r\n\tprivate _heartbeatTime: number;\r\n\tprivate _isEnableHeartbeat: boolean;\r\n\tprivate updateTimer:number;\r\n\tpublic constructor(webSocket: any){\r\n\t\tthis._messages = [];\r\n\t\tthis._heartbeatTime = 0;\r\n\t\tthis._writeMessage = [];\r\n\t\tthis._webSocket = webSocket;\r\n\t\tthis.setHeartbeatInterval(30);//30秒\r\n\t\tthis._isEnableHeartbeat = false;\r\n\t}\r\n\r\n\tpublic set enableHeartbeat(flag: boolean){\r\n\t\tthis._isEnableHeartbeat = flag;\r\n\t}\r\n\r\n\tpublic get enableHeartbeat(): boolean {\r\n\t\treturn this._isEnableHeartbeat;\r\n\t}\r\n\r\n\tpublic setHeartbeatInterval(time: number){//秒\r\n\t\tif(time <= 0) time = 1;\r\n\t\tthis._heartbeatInterval = time * 1000;\r\n\t}\r\n\r\n\tprivate onUpdate(timeStamp: number): boolean{\r\n\t\tif(this._writeMessage.length > 0){\r\n\t\t\tlet msg = this._writeMessage[0];\r\n\t\t\tlet message = msg.pack();\r\n\t\t\tif(this._webSocket.readyState == WebSocket.OPEN){\r\n\t\t\t\tconsole.log(\"size: \" + message.byteLength);\r\n\t\t\t\tthis._webSocket.send(message);\r\n\t\t\t\tthis._writeMessage.shift();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this._messages.length > 0){\r\n\t\t\tlet msg = this._messages.shift();\r\n\t\t\tthis.dispatchMessage(msg);\r\n\t\t}\r\n\t\tif(this._isEnableHeartbeat)\r\n\t\t\tthis.checkHeartbeat();\r\n\t\treturn false;\r\n\t}\r\n\r\n\tprivate checkHeartbeat(){\r\n\t\tlet diff = new Date().getTime() - this._heartbeatTime;\r\n\t\tif( diff >= this._heartbeatInterval){\r\n\t\t\tthis.sendMessage(new Message(game.Command.Heartbeat));\r\n\t\t\tthis._heartbeatTime = new Date().getTime();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic dispatchMessage(msg: any){\r\n\t\tlet dispatch = MessageDispatch.getInstance();\r\n\t\tif(!dispatch.onMessage(msg)) {\r\n\t\t\tthis._messages.push(msg);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate dispatchSocket(type: SocketTag){\r\n\t\tlet obj = {type: type};\r\n\t\tthis.dispatchMessage(obj);\r\n\t}\r\n\r\n\tpublic dispatch(type: SocketTag, msg: any){\r\n\t\tif(type == SocketTag.KSOCKET_OPEN){\r\n\t\t\t// cc.director.getScheduler().unschedule(this.onUpdate,this)\r\n\t\t\t// cc.director.getScheduler().schedule(this.onUpdate,this,0);\r\n\t\t\tclearInterval(this.updateTimer);\r\n\t\t\tthis.updateTimer = setInterval(dt=>this.onUpdate(dt), 1000/60);\r\n\t\t\tthis.dispatchSocket(type);\r\n\t\t}else if(type == SocketTag.KSOCKET_CLOSE){\r\n\t\t\tclearInterval(this.updateTimer);\r\n\t\t\tthis.dispatchSocket(type);\r\n\t\t}else if(type == SocketTag.KSOCKET_ERROR){\r\n\t\t\tclearInterval(this.updateTimer);\r\n\t\t\tthis.dispatchSocket(type);\r\n\t\t}else if(type == SocketTag.KSOCKET_MESSAGE){\r\n\t\t\tlet obj = {type: type, msg: msg};\r\n\t\t\tthis.dispatchMessage(obj);\r\n\t\t}\r\n\t}\r\n\r\n\tpublic clearWriteMessage(){\r\n\t\tthis._writeMessage = [];\r\n\t}\r\n\r\n\tpublic clearMessage(){\r\n\t\tthis._messages = [];\r\n\t}\r\n\r\n\tpublic sendMessage(msg: Message){\r\n\t\tthis._writeMessage.push(msg);\r\n\t}\r\n}"]}